from re import match

from flask import (
    Flask, 
    redirect, 
    render_template,
    url_for,
    request
)

from db import (
    create_connection,
    find_id_by_params,
    get_table_rows,
    execute_query,
    insert_data
)

from crawler import (
    CrawlerManager
)

from crawler_handler import (
    crawler_handler
)

app = Flask(__name__)

@app.route('/events')
def events():
    conn = create_connection()
    events = execute_query(
        conn=conn,
        query="SELECT Event.event_date, Cve.name, Event.source "\
            "FROM Event LEFT JOIN Cve ORDER BY Event.id DESC;",
    )

    return render_template(
        'events.html', 
        title="Events",
        header1=f"{len(events)} Events occurred during the program run",
        events=events
    )

@app.route('/vulnerabilities')
def vulnerabilities():
    conn = create_connection()
    cves = get_table_rows(
        conn=conn,
        table_name="Cve"
    )

    return render_template(
        'vulnerabilities.html', 
        title="Vulnerabilities",
        header1=f"{len(cves)} Vulnerabilities were crawled and parsed",
        cves=cves
    )

@app.route('/cve/<cve_id>', methods=['GET', 'POST'])
def cve(cve_id: str):
    conn = create_connection()

    regex_check = match(
        r"[Cc][Vv][Ee]\-\d{4}\-\d{2,5}",
        cve_id
    )

    cve_not_found_page = render_template(
        'content.html', 
        title="Page Not Found",
        header1=f"Cve {str(cve_id)} was not found in base",
        content="We apologize, this Cve is not in the database, \
            most likely it was not processed by this mechanism \
            due to not being in the time slot. \
            If you are trying to phase this page on purpose, \
            please give up, it's a silly idea"
    )

    if not regex_check:
        return cve_not_found_page

    found_cve_id = find_id_by_params(
        conn=conn,
        table_name='Cve',
        search_columns=['name'],
        search_values=(cve_id,)
    )

    if not found_cve_id:
        return cve_not_found_page

    query_technique_id = request.args.get('technique')
    if query_technique_id:
        found_technique_id = find_id_by_params(
            conn=conn,
            table_name='MitreTechnique',
            search_columns=['technique_id'],
            search_values=(query_technique_id,)
        )
        
        if found_technique_id:
            insert_data(
                conn=conn,
                table_name='CveTechnique',
                columns=['cve_id', 'technique_id'],
                values=(found_cve_id, found_technique_id,)
            )
    
    cve_info = execute_query(
        conn=conn,
        query="SELECT cvss, belonging, cwe_id, published_date, name FROM Cve WHERE id=?",
        values=(found_cve_id,),
        is_one=True
    )

    descriptions = execute_query(
        conn=conn,
        query=f"SELECT * from Description WHERE cve_id=? ORDER BY priority ASC;",
        values=(found_cve_id,)
    )

    techniques = execute_query(
        conn=conn,
        query=f"SELECT technique_id, name FROM MitreTechnique WHERE id IN "\
        "(SELECT technique_id FROM CveTechnique WHERE cve_id = ?);",
        values=(found_cve_id,)
    )

    print(techniques)

    return render_template(
        'cve_page.html', 
        title=f"{cve_id}",
        header1=f"Vulnerability {str(cve_id)} information",
        cve_info=cve_info,
        descriptions=descriptions,
        techniques=techniques
    )

@app.route('/search_cve', methods=['GET'])
def search_cve():
    query = request.args.get('query')
        
    conn = create_connection()
    response = execute_query(
        conn=conn,
        query="SELECT name, published_date FROM Cve WHERE id IN "\
        "(SELECT cve_id FROM Description WHERE value LIKE '%' || ? || '%');",
        values=(query, )
    )

    return render_template(
        'cve_search.html', 
        title="Search CVE",
        header1=f"Results for query: {query}",
        cves=response
    )

@app.route('/cwe/<cwe_id>')
def cwe(cwe_id: str):
    conn = create_connection()

    regex_check = match(
        r"\d{1,4}",
        cwe_id
    )

    error_page = render_template(
        'content.html', 
        title="Page Not Found",
        header1=f"CWE-{str(cwe_id)} was not found in base",
        content="We apologize, this CWE is not in the database"
    )

    if not regex_check:
        return error_page

    cwe = execute_query(
        conn=conn,
        query=f"SELECT * from Cwe WHERE id=?",
        values=(cwe_id,)
    )

    if not cwe:
        return error_page

    cwe = cwe[0]

    return render_template(
        'content.html',
        title=f"CWE-{str(cwe_id)}",
        header1=f"CWE-{cwe[0]} information",
        content=cwe[1]
    )

@app.route('/')
@app.route('/about')
def about():
    return render_template(
        'content.html', 
        title="About",
        header1="Page about project",
        content="The project is aimed at collecting \
            and centralizing vulnerability data (CVE) \
            from various sources. It aims to provide \
            convenient access to vulnerability information, \
            assisting users in quickly obtaining up-to-date \
            data."
    )

@app.route('/update')
def update():
    cm = CrawlerManager()
    
    crawler_handler(
        sources=cm.crawl_sources()
    )
    
    return redirect(
        url_for('events'), 
        code=302, 
        Response=None
    )