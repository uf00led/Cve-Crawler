from flask import (
    Flask, 
    redirect, 
    render_template,
    url_for
)

from db import (
    create_connection,
    get_table_rows,
    execute_query
)

from crawler import (
    CrawlerManager
)

from crawler_handler import (
    crawler_handler
)

app = Flask(__name__)

@app.route('/')
def index():
    return render_template(
        'base.html', 
        title="Index"
    )

@app.route('/events')
def events():
    conn = create_connection()
    events = execute_query(
        conn=conn,
        query="SELECT Event.id, Event.event_date, Event.source, Cve.name "\
            "FROM Event LEFT JOIN Cve ORDER BY Event.id DESC;",
    )

    return render_template(
        'events.html', 
        title="Events",
        header1=f"{len(events)} Events occurred during the program run",
        events=events
    )

@app.route('/vulnerabilities')
def vulnerabilities():
    conn = create_connection()
    cves = get_table_rows(
        conn=conn,
        table_name="Cve"
    )

    return render_template(
        'vulnerabilities.html', 
        title="Vulnerabilities",
        header1=f"{len(cves)} Vulnerabilities were crawled and parsed",
        cves=cves
    )

@app.route('/update')
def update():
    cm = CrawlerManager()
    
    crawler_handler(
        sources=cm.crawl_sources()
    )
    
    return redirect(
        url_for('events'), 
        code=302, 
        Response=None
    )